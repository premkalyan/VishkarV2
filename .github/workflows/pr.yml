name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  PYTHON_VERSION: "3.11"

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better diff

      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          # Allow conventional commits or JIRA ticket format
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|ci)(\(.+\))?:.*$ ]] && \
             [[ ! "$PR_TITLE" =~ ^V2-[0-9]+:.*$ ]]; then
            echo "PR title should follow conventional commits or include JIRA ticket"
            echo "Examples:"
            echo "  feat: add new feature"
            echo "  fix(auth): resolve login issue"
            echo "  V2-32: implement CI/CD pipeline"
            exit 1
          fi

      - name: Check for large files
        run: |
          MAX_SIZE=1000000  # 1MB
          LARGE_FILES=$(find . -type f -size +${MAX_SIZE}c -not -path "./.git/*" 2>/dev/null || true)
          if [ -n "$LARGE_FILES" ]; then
            echo "Large files detected (>1MB):"
            echo "$LARGE_FILES"
            exit 1
          fi

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Lint
        run: |
          source .venv/bin/activate
          ruff check src tests --output-format=github

      - name: Format check
        run: |
          source .venv/bin/activate
          ruff format --check src tests

      - name: Type check
        run: |
          source .venv/bin/activate
          mypy src --ignore-missing-imports

  test-coverage:
    name: Test & Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Run tests
        run: |
          source .venv/bin/activate
          pytest tests/ -v --cov=src --cov-report=xml --cov-fail-under=70

      - name: Coverage comment
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ github.token }}
          MINIMUM_GREEN: 80
          MINIMUM_ORANGE: 60
        continue-on-error: true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          uv venv
          uv pip install bandit safety

      - name: Run Bandit security scan
        run: |
          source .venv/bin/activate
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -ll  # Fail on medium+ severity

      - name: Check dependencies for vulnerabilities
        run: |
          source .venv/bin/activate
          uv pip freeze > requirements.txt
          safety check -r requirements.txt --output json > safety-report.json || true
          safety check -r requirements.txt
        continue-on-error: true  # Don't fail on safety for now
